---
title: "R Notebook"
output: html_notebook
---

```{r}
# load required packages
suppressPackageStartupMessages(library(ggplot2, quietly = T))
suppressPackageStartupMessages(library(matrixStats, quietly = T))
suppressPackageStartupMessages(library(FactoMineR, quietly = T))
suppressPackageStartupMessages(library(MASS, quietly = T))
suppressPackageStartupMessages(library(parallelDist, quietly = T))
# suppressPackageStartupMessages(library(dendextend, quietly = T))
suppressPackageStartupMessages(library(RColorBrewer, quietly = T))

# read in normed methylation data from Jung and Leanna
bVals_Jung = readRDS("../data/Jung_champnorm_small.rds")
bVals_Leanna = readRDS("../data/WvT_champnorm_small.rds")
nsamples_Jung = ncol(bVals_Jung)

# merge datasets by CpG name and set rownames
bVals <- bVals_Jung# merge(bVals_Jung, bVals_Leanna, by=0)

# read in phenotype metadata, extract cell line metadata from column names
pheno_Jung <- readRDS(paste0("../data/Jung_pheno.rds"))
pheno = data.frame(dataset = "Jung",
                   cell.type = as.character(pheno_Jung$Subject.ID))

# set cell type factor levels for proper ordering
pheno$cell.type <- factor(pheno$cell.type, 
                          levels=c("HSC", "MPP", "LMPP", "CMP", "GMP", "MEP", 
                                   "CD34-", "CD34+38+", "CD34+38-"))

# set up palette for consistent colors across figures
pal <- c("tomato3", "sienna2", "darkgoldenrod1", "darkolivegreen2", "springgreen3", "mediumseagreen", 
                 "deeppink1", "darkorchid1", "darkorchid4")
names(pal) <- levels(pheno$cell.type)

```


```{r}
# sample 16,000 rows (or CpGs) to use in PCA
bVals_small = bVals[sample(1:nrow(bVals), 16000), ]

# find top 3 PCs with PCA of smaller dataset
num_dimensions_PCA = 3
bVal_PCA = PCA(t(bVals_small), ncp=num_dimensions_PCA, scale.unit=T, graph=F)

# get transformed coords, and add metadata for simpler ggplot visualization
plot_PCA = as.data.frame(bVal_PCA$ind$coord)
names(plot_PCA) <- paste0("PC", 1:num_dimensions_PCA)
plot_PCA$dataset <- pheno$dataset
plot_PCA$cell.type <- pheno$cell.type

# scatterplot of PC1 v PC2 colored by cell type
ggplot(plot_PCA, aes(x=PC1, y=PC2, color=cell.type)) +
  geom_point() + theme_classic() +
  scale_color_manual(values=pal) + labs(color="Cell type")

```


```{r}
# sample 1000 rows (or CpGs) to plot in heatmap
bVals_small = bVals[sample(1:nrow(bVals), 1000), ]

# how do patient cancer samples cluster
# AKA is it easy to find out what separates cancer stem cells from proliferative cancer cells?
samps = pheno$cell.type %in% c("CD34-", "CD34+38+", "CD34+38-")
cluster_me <- t(bVals_small)[samps,]
clusters <- as.dendrogram(stats::hclust(parDist(cluster_me, method="manhattan"), method="complete"))

# change colors
labels_colors(clusters) <- pal[pheno[samps,][order.dendrogram(clusters), "cell.type"]]
morecols <- colorRampPalette(c("dodgerblue4", "gray0", "firebrick4"))

# show heatmap
gplots::heatmap.2(cluster_me, 
                  srtCol = 20,
                  dendrogram = "both",
                  Rowv = clusters,
                  Colv = T,
                  labCol = NA,
                  labRow = NA,
                  trace = "none",          
                  margins = c(5,0.1),      
                  key.xlab = NA,
                  key.title = "Methylation",
                  denscol = "grey",
                  density.info = "density",
                  RowSideColors = pal[pheno[samps,][,"cell.type"]], # to add nice colored strips
                  col = morecols(13)
                  )

```

```{r}
# How do normal cells cluster?
samps = pheno$cell.type %in% c("HSC", "MPP", "LMPP", "CMP", "GMP", "MEP")
cluster_me <- t(bVals_small)[samps,]
clusters <- as.dendrogram(stats::hclust(parDist(cluster_me, method="manhattan"), method="complete"))

labels_colors(clusters) <- pal[pheno[samps,][order.dendrogram(clusters), "cell.type"]]
morecols <- colorRampPalette(c("dodgerblue4", "gray0", "firebrick4"))

gplots::heatmap.2(cluster_me, 
                  srtCol = 20,
                  dendrogram = "both",
                  Rowv = clusters,
                  Colv = T,
                  labCol = NA,
                  labRow = NA,
                  trace = "none",          
                  margins = c(5,0.1),      
                  key.xlab = NA,
                  key.title = "Methylation",
                  denscol = "grey",
                  density.info = "density",
                  RowSideColors = pal[pheno[samps,][,"cell.type"]], # to add nice colored strips
                  col = morecols(13)
                  )
```


```{r}
# find top 16,000 most variable CpGs
bVals_summary = data.frame(mean=rowMeans(bVals),
                           stdev=rowSds(as.matrix(bVals)))
bVals_summary = bVals_summary[order(bVals_summary$stdev, decreasing=T),]
bVals_small = bVals[rownames(bVals_summary[1:16000,]),]

# Use LDA to separate HSCs, LSCs, and differentiated tumor cells
train_grps = pheno$cell.type %in% c("HSC", "CD34-", "CD34+38-")
bVals_LDA <- t(scale(bVals_small))[train_grps,]

# add cell type as a metadata column, set factor order
bVals_LDA <- data.frame(bVals_LDA, cell.type = pheno$cell.type[train_grps])
bVals_LDA$cell.type <- factor(as.character(bVals_LDA$cell.type), 
                              levels = c("HSC", "MPP", "LMPP", "CMP", "GMP", "MEP", "CD34-", "CD34+38+", "CD34+38-"))

# train LDA
dfLDA = lda(formula = cell.type ~ .,
            data=LDAme)
prop = dfLDA$svd^2/sum(dfLDA$svd^2)
prop 

plda = predict(object=dfLDA,
               newdata=as.data.frame(LDAme))

ggplot(data=as.data.frame(plda$x), aes(x=LD1, y=LD2, color=pheno$cell.type)) + geom_point() +
  scale_color_manual(values=pal) + theme_classic()


```

